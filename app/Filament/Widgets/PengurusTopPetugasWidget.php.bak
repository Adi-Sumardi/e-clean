<?php

namespace App\Filament\Widgets;

use App\Models\ActivityReport;
use App\Models\User;
use Carbon\Carbon;
use Filament\Tables;
use Filament\Tables\Table;
use Filament\Widgets\TableWidget as BaseWidget;
use Illuminate\Database\Eloquent\Builder;

class PengurusTopPetugasWidget extends BaseWidget
{
    protected static ?int $sort = 5;
    protected int | string | array $columnSpan = 'full';

    public static function canView(): bool
    {
        return auth()->user()->hasRole('pengurus');
    }

    public function table(Table $table): Table
    {
        $thisMonth = Carbon::now()->startOfMonth();

        return $table
            ->heading('ğŸ† Top 5 Petugas Bulan Ini')
            ->description('Berdasarkan jumlah laporan approved dan rating')
            ->query(
                User::query()
                    ->role('petugas')
                    ->whereHas('activityReports', function (Builder $query) use ($thisMonth) {
                        $query->where('tanggal', '>=', $thisMonth)
                            ->where('status', 'approved');
                    })
                    ->withCount([
                        'activityReports as reports_count' => function (Builder $query) use ($thisMonth) {
                            $query->where('tanggal', '>=', $thisMonth);
                        },
                        'activityReports as approved_count' => function (Builder $query) use ($thisMonth) {
                            $query->where('tanggal', '>=', $thisMonth)
                                ->where('status', 'approved');
                        }
                    ])
                    ->withAvg([
                        'activityReports as avg_rating' => function (Builder $query) use ($thisMonth) {
                            $query->where('tanggal', '>=', $thisMonth)
                                ->where('status', 'approved');
                        }
                    ], 'rating')
                    ->orderByDesc('approved_count')
                    ->orderByDesc('avg_rating')
                    ->limit(5)
            )
            ->columns([
                Tables\Columns\TextColumn::make('rank')
                    ->label('#')
                    ->state(function ($rowLoop) {
                        $ranks = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', '4', '5'];
                        return $ranks[$rowLoop->index] ?? ($rowLoop->index + 1);
                    })
                    ->alignCenter()
                    ->size('lg'),

                Tables\Columns\TextColumn::make('name')
                    ->label('Nama Petugas')
                    ->searchable()
                    ->sortable()
                    ->weight('bold')
                    ->icon('heroicon-m-user')
                    ->iconColor('primary'),

                Tables\Columns\TextColumn::make('reports_count')
                    ->label('Total Laporan')
                    ->alignCenter()
                    ->badge()
                    ->color('info'),

                Tables\Columns\TextColumn::make('approved_count')
                    ->label('Approved')
                    ->alignCenter()
                    ->badge()
                    ->color('success'),

                Tables\Columns\TextColumn::make('approval_rate')
                    ->label('Approval Rate')
                    ->state(function (User $record): string {
                        if ($record->reports_count == 0) {
                            return '0%';
                        }
                        $rate = ($record->approved_count / $record->reports_count) * 100;
                        return number_format($rate, 1) . '%';
                    })
                    ->alignCenter()
                    ->badge()
                    ->color(fn (User $record): string =>
                        $record->reports_count > 0 && ($record->approved_count / $record->reports_count) >= 0.8
                            ? 'success'
                            : 'warning'
                    ),

                Tables\Columns\TextColumn::make('avg_rating')
                    ->label('Avg Rating')
                    ->state(fn (User $record): string =>
                        $record->avg_rating ? number_format($record->avg_rating, 1) . ' â­' : 'N/A'
                    )
                    ->alignCenter()
                    ->color(fn (User $record): string =>
                        $record->avg_rating >= 4 ? 'success' : ($record->avg_rating >= 3 ? 'warning' : 'danger')
                    ),
            ])
            ->paginated(false);
    }
}
